<?xml version="1.0"?>
<s:Window xmlns:fx="http://ns.adobe.com/mxml/2009" xmlns:s="library://ns.adobe.com/flex/spark"
          systemChrome="none"
          width="640"
          height="480"
          skinClass="wall.skin.OutWindowSkin"
          xmlns:mx="library://ns.adobe.com/flex/mx"
          initialize="window1_initializeHandler(event)"
        >
    <fx:Script><![CDATA[
        import com.dborisenko.api.twitter.data.TwitterStatus;

        import flash.sampler.sampleInternalAllocs;

        import mx.collections.ArrayCollection;
        import mx.events.FlexEvent;

        public var twitterHolderArray:ArrayCollection = new ArrayCollection;
        public static const MAX_SHOWN_TWITTS:int = 5;

        private var fontSize:uint = 14;
        private var fontColor:uint = 16777215;
        private var hashColor:String = "#A6E22E";


        protected function window1_initializeHandler(event:FlexEvent):void {
            addEventListener(KeyboardEvent.KEY_DOWN, keyDownEvent);
            this.setFocus();
        }

        private function keyDownEvent(evt:KeyboardEvent):void {
            if (evt.keyCode == Keyboard.ESCAPE) {
                this.close();
            }
        }



        protected function group1_mouseDownHandler(event:MouseEvent):void {
            stage.nativeWindow.startMove();
        }

        protected function group1_mouseUpHandler(event:MouseEvent):void {
            this.stopDrag();
        }

        protected function group1_doubleClickHandler(event:MouseEvent):void {

        }

        public function setTwitts(tlArray:ArrayCollection) {
            destroyHolders();
            twitterHolderArray.removeAll();
            markWall.removeAllElements();
            System.gc();
            System.gc();
            var th:TwittHolder;
            for (var i:int = 0; i < MAX_SHOWN_TWITTS; i++) {
                var tStatus:TwitterStatus = tlArray.getItemAt(i) as TwitterStatus;
                 th = genereateHolder(tStatus);
                th.setFontSize(fontSize);
                th.setTime(tStatus.createdAt.hours, tStatus.createdAt.minutes);
                th.setFontColor(fontColor);
                th.setImage(tStatus.user.profileImageUrl);
                th.setLineColor(hashColor);
                twitterHolderArray.addItem(th);
                markWall.addElement(th);

            }
        }

        private function genereateHolder(tStatus:TwitterStatus):TwittHolder {
            var twittHolder:TwittHolder = new TwittHolder();
            twittHolder.setMsgTextFlow(TextFormater.formatStatus(tStatus.text, tStatus.user.name,hashColor), tStatus.text.length);
            return twittHolder;
        }

        private function destroyHolders() {
            var th:TwittHolder;
            for (var i:int = 0; i < twitterHolderArray.length; i++) {
                th = (twitterHolderArray.getItemAt(i) as TwittHolder);
                th.removeAllElements();
                th = null;
            }
        }

        public function changeTextColor(color:uint) {
            fontColor = color;
            setFontColor();
        }

        public function changeHashColor(color:String) {
            hashColor = color;
        }

        private function changeFontSize(size:uint) {
            fontSize = size;
            setFontSize();
        }

        public function changeFontColor(color:uint) {
            fontColor = color;
            setFontColor();
        }

        public function setFontSize() {
            for (var i:int = 0; i < twitterHolderArray.length; i++) {
                (twitterHolderArray.getItemAt(i) as TwittHolder).setFontSize(fontSize);
            }
        }

        public function setFontColor() {
            for (var i:int = 0; i < twitterHolderArray.length; i++) {
                (twitterHolderArray.getItemAt(i) as TwittHolder).setFontColor(fontColor);
            }
        }
        ]]></fx:Script>
    <s:layout>
        <s:BasicLayout/>
    </s:layout>
    <s:Group id="content"
             width="100%"
             height="100%"
             mouseDown="group1_mouseDownHandler(event)"
             mouseUp="group1_mouseUpHandler(event)"
             doubleClickEnabled="true"
             doubleClick="group1_doubleClickHandler(event)">
        <s:Rect width="100%" height="100%">
            <s:fill>
                <s:SolidColor color="#000000"/>
            </s:fill>
        </s:Rect>
        <s:Group verticalCenter="0" horizontalCenter="0" width="100%" height="100%">
            <s:VGroup id="markWall" gap="10" horizontalCenter="0" top="40" height="100%">

            </s:VGroup>
        </s:Group>

    </s:Group>
</s:Window>
